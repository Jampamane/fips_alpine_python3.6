FROM ubuntu:20.04

# Install dependencies for Wine and FIPS
RUN dpkg --add-architecture i386 && \
    apt-get update && \
    apt-get install -y \
    wine64 \
    wine32 \
    curl \
    xz-utils \
    ca-certificates \
    unzip \
    python3-pip \
    python3.11-venv \
    python3.11-dev \
    build-essential \
    fips-kernel-modules \
    libssl-dev \
    dracut-fips

# Enable FIPS mode
RUN apt-get install -y dracut-fips && \
    dracut --add fips --force && \
    echo "FIPS=1" > /etc/default/grub && \
    update-grub

# Install Python 3.11 for Wine (Windows version)
RUN curl -LO https://www.python.org/ftp/python/3.11.0/python-3.11.0.exe && \
    wine start /unix python-3.11.0.exe /quiet InstallAllUsers=1 PrependPath=1 && \
    rm python-3.11.0.exe

# Set up Wine environment
RUN wineboot --init

# Ensure Wine uses Python 3.11
ENV PATH="/root/.wine/drive_c/Python311:/root/.wine/drive_c/Python311/Scripts:$PATH"

# Ensure FIPS-approved OpenSSL is being used
RUN update-ca-certificates && \
    curl https://www.openssl.org/source/openssl-1.1.1k.tar.gz -o openssl.tar.gz && \
    tar -xvzf openssl.tar.gz && \
    cd openssl-1.1.1k && \
    ./config fips && \
    make && make install

# Set OpenSSL to FIPS mode
RUN echo "openssl_conf = openssl_init" > /root/.wine/drive_c/Python311/openssl.cnf && \
    echo "openssl_init = fips" >> /root/.wine/drive_c/Python311/openssl.cnf

# Test Python with Wine and FIPS mode
RUN wine python --version && \
    wine python -c "import ssl; print(ssl.OPENSSL_VERSION)"

# Use the container to run Wine Python commands
CMD ["bash"]
