# Stage 1: Build stage
FROM alpine:3.6 AS builder

# Install build dependencies and entropy daemon
RUN apk add --no-cache \
    build-base \
    curl \
    wget \
    make \
    gcc \
    musl-dev \
    zlib-dev \
    linux-headers \
    libffi-dev \
    perl \
    nasm \
    readline-dev \
    sqlite-dev \
    gdbm-dev \
    ncurses-dev \
    tk-dev \
    zip \
    unzip \
    haveged

# Ensure OpenSSL RNG uses urandom
ENV RANDFILE=/dev/urandom

# Download and build FIPS OpenSSL
ENV OPENSSL_VERSION=3.0.7
RUN curl -LO https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz && \
    tar -xvzf openssl-${OPENSSL_VERSION}.tar.gz && \
    cd openssl-${OPENSSL_VERSION} && \
    ./config fips no-shared --prefix=/usr/local --openssldir=/usr/local/ssl --libdir=/usr/local/lib && \
    make -j$(nproc) && make install && \
    cd .. && rm -rf openssl-${OPENSSL_VERSION}*

# Create FIPS-enabled openssl.cnf
RUN mkdir -p /usr/local/ssl && \
    echo "openssl_conf = openssl_init" > /usr/local/ssl/openssl.cnf && \
    echo "[openssl_init]" >> /usr/local/ssl/openssl.cnf && \
    echo "providers = provider_sect" >> /usr/local/ssl/openssl.cnf && \
    echo "alg_section = algorithm_sect" >> /usr/local/ssl/openssl.cnf && \
    echo "[provider_sect]" >> /usr/local/ssl/openssl.cnf && \
    echo "fips = fips_sect" >> /usr/local/ssl/openssl.cnf && \
    echo "base = base_sect" >> /usr/local/ssl/openssl.cnf && \
    echo "[fips_sect]" >> /usr/local/ssl/openssl.cnf && \
    echo "activate = 1" >> /usr/local/ssl/openssl.cnf && \
    echo "[base_sect]" >> /usr/local/ssl/openssl.cnf && \
    echo "activate = 1" >> /usr/local/ssl/openssl.cnf

# Set environment for Python build
ENV LD_LIBRARY_PATH=/usr/local/lib
ENV OPENSSL_CONF=/usr/local/ssl/openssl.cnf

# Download and build Python 3.6.15
ENV PYTHON_VERSION=3.6.15
RUN curl -LO https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tgz && \
    tar -xvzf Python-${PYTHON_VERSION}.tgz && \
    cd Python-${PYTHON_VERSION} && \
    ./configure --prefix=/usr/local --with-openssl=/usr/local --enable-optimizations --enable-shared && \
    make -j$(nproc) && make altinstall && \
    cd .. && rm -rf Python-${PYTHON_VERSION}*

# Symlink python3 and pip3
RUN ln -sf /usr/local/bin/python3.6 /usr/bin/python3 && \
    ln -sf /usr/local/bin/pip3.6 /usr/bin/pip3

# Stage 2: Final image (smaller)
FROM alpine:3.6

# Copy Python and OpenSSL from builder
COPY --from=builder /usr/local /usr/local

# Set FIPS environment variables
ENV LD_LIBRARY_PATH=/usr/local/lib
ENV OPENSSL_CONF=/usr/local/ssl/openssl.cnf
ENV RANDFILE=/dev/urandom

# Install runtime dependencies only
RUN apk add --no-cache \
    zlib \
    libffi \
    readline \
    sqlite \
    ncurses \
    tk \
    bash \
    curl \
    zip \
    unzip \
    binutils

# Verify FIPS-enabled OpenSSL (optional)
RUN /usr/local/bin/openssl version -a

CMD ["python3"]
